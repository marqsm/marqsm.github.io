<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Code, Cook, Sleep, repeat.]]></title>
  <link href="http://marqsm.github.io/atom.xml" rel="self"/>
  <link href="http://marqsm.github.io/"/>
  <updated>2014-08-14T14:54:22-04:00</updated>
  <id>http://marqsm.github.io/</id>
  <author>
    <name><![CDATA[Marcus Malka]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Using Esprima to Process JavaScript]]></title>
    <link href="http://marqsm.github.io/blog/2014/08/13/using-esprima-to-process-javascript/"/>
    <updated>2014-08-13T19:35:29-04:00</updated>
    <id>http://marqsm.github.io/blog/2014/08/13/using-esprima-to-process-javascript</id>
    <content type="html"><![CDATA[<p>It&rsquo;s my third-last week in <a href="http://www.hackerschool.com">Hacker School</a>, and people seem to play around a lot with ASTs (mostly in Python with provides run-time AST modification - how cool is that!?!). No wonder, after <a href="http://notes.pault.ag/">Paul Tagliamonte</a> demonstrated <a href="https://www.youtube.com/watch?v=AmMaN1AokTI">how much fun</a> it is!</p>

<p>I&rsquo;ve been using them to create my learning tool that overloads JS operators with more transparent versions modified from V8 code.</p>

<p>This is a simplified walkthrough of the essential parts of the overloading process.</p>

<p>The REPL is still under construction but I&rsquo;ll link it to this article when I get it to a stable state.</p>

<h3>Goal</h3>

<p>For my REPL I need to overload javascript operators and functions with my own functions. Since JS doesn&rsquo;t have operator overloading, I&rsquo;ll need to take the code in, replace the things I want to overload, and run the code.</p>

<p>Other possible uses for similar pipeline are syntax checking, adding logging magically to all functions in the codebase, code minification / obfuscation lisp/c-like macros etc. So this is very powerful for most kind of JS preprocessing.</p>

<p>Say I&rsquo;d like to transform</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var a = 4 + "foo";</span></code></pre></td></tr></table></div></figure>


<p>to</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var a = ADD(4, foo);</span></code></pre></td></tr></table></div></figure>


<p>Seems clear? Let&rsquo;s see how we&rsquo;ll go about doing it.</p>

<h3>Summary of actions</h3>

<ol>
<li>Create an abstract syntax tree from the code</li>
<li>Replace the function calls (from the tree)</li>
<li>Re-create the JS-code (from the syntax tree)</li>
<li>Run the modified code (good old eval)</li>
</ol>


<h3>How</h3>

<h4>Getting ready</h4>

<p>First thing is to include esprima.js, which you can get through <a href="http://bower.io/">bower</a>. Esprima parses your JS code to an <a href="http://en.wikipedia.org/wiki/Abstract_syntax_tree">abstract syntax tree</a> (AST). This is a tree-representation of your program, which can be manipulated more easily and systematically than text-shaped code. You can play with the <a href="http://esprima.org/demo/parse.html">esprima demo</a> and see what kind of ASTs your code produces.</p>

<p>To get it running on your own machine, first step is naturally to install it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bower install esprima</span></code></pre></td></tr></table></div></figure>


<p>Include in your JS, and you&rsquo;re ready to dabble!</p>

<h4>1. Creating abstract syntax trees</h4>

<p>I want to see the syntax trees my different rows generate, so my test is</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var ast = esprima.parse("var answer = 34 + 8"),
</span><span class='line'>    ast2 = esprima.parse("var answer2 = ADD(34, 8)")</span></code></pre></td></tr></table></div></figure>


<p>Which means I can see how the syntax trees differ for my source and target tree.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "type": "Program",
</span><span class='line'>  "body": [
</span><span class='line'>    {
</span><span class='line'>      "type": "VariableDeclaration",
</span><span class='line'>      "declarations": [
</span><span class='line'>        {
</span><span class='line'>          "type": "VariableDeclarator",
</span><span class='line'>          "id": {
</span><span class='line'>            "type": "Identifier",
</span><span class='line'>            "name": "answer"
</span><span class='line'>          },
</span><span class='line'>          "init": {
</span><span class='line'>            "type": "BinaryExpression",
</span><span class='line'>            "operator": "+",
</span><span class='line'>            "left": {
</span><span class='line'>              "type": "Literal",
</span><span class='line'>              "value": 34,
</span><span class='line'>              "raw": "34"
</span><span class='line'>            },
</span><span class='line'>            "right": {
</span><span class='line'>              "type": "Literal",
</span><span class='line'>              "value": 8,
</span><span class='line'>              "raw": "8"
</span><span class='line'>            }
</span><span class='line'>          }
</span><span class='line'>        }
</span><span class='line'>      ],
</span><span class='line'>      "kind": "var"
</span><span class='line'>    }
</span><span class='line'>  ]
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>The ast2 part seems otherwise the same, but init-part is different..</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  "init": {
</span><span class='line'>    "type": "CallExpression",
</span><span class='line'>    "callee": {
</span><span class='line'>      "type": "Identifier",
</span><span class='line'>      "name": "ADD"
</span><span class='line'>    },
</span><span class='line'>    "arguments": [
</span><span class='line'>      {
</span><span class='line'>        "type": "Literal",
</span><span class='line'>        "value": 34,
</span><span class='line'>        "raw": "34"
</span><span class='line'>      },
</span><span class='line'>      {
</span><span class='line'>        "type": "Literal",
</span><span class='line'>        "value": 8,
</span><span class='line'>        "raw": "8"
</span><span class='line'>      }
</span><span class='line'>    ]
</span><span class='line'>  }</span></code></pre></td></tr></table></div></figure>


<h4>2. Replace the function calls</h4>

<p>So I&rsquo;ll make a function that overwrites the former with the latter:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>function replacePlusByADD(node) {
</span><span class='line'>    // get operands from +
</span><span class='line'>    var a = node.left,
</span><span class='line'>        b = node.right;
</span><span class='line'>
</span><span class='line'>    node.type = "CallExpression";
</span><span class='line'>    node.callee = {
</span><span class='line'>      "type": "Identifier",
</span><span class='line'>      "name": "ADD"
</span><span class='line'>    };
</span><span class='line'>    node.arguments = [a, b];
</span><span class='line'>
</span><span class='line'>    // reset unnecessary properties
</span><span class='line'>    node.left = null;
</span><span class='line'>    node.right = null;
</span><span class='line'>    node.operator = null;
</span><span class='line'>
</span><span class='line'>    return node;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ll use <code>estraverse</code> for the AST traversal</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var ast  = esprima.parse(code);
</span><span class='line'>estraverse.traverse(ast, {
</span><span class='line'>    enter: function(node) {
</span><span class='line'>        if (node.type === "BinaryExpression") {
</span><span class='line'>            replacePlusByADD(node);
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>});</span></code></pre></td></tr></table></div></figure>


<h4>3 &amp; 4. Re-create the JS-code and run</h4>

<p>This is really just</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>var modified_code = escodegen.generate(ast);
</span><span class='line'>
</span><span class='line'>eval(modified_code);</span></code></pre></td></tr></table></div></figure>


<p>And Voilà! We have just created a JS pre-processor.</p>

<p>I found playing around with these tools, very much fun, in addition to helping me make pretty complex things in very few lines of code.</p>

<p>More resources:
<a href="http://sevinf.github.io/blog/2012/09/29/esprima-tutorial/">Esprima
tutorial</a>
<a href="http://tobyho.com/2013/12/02/fun-with-esprima/">Fun with Esprima</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Hash Extension Attack]]></title>
    <link href="http://marqsm.github.io/blog/2014/08/06/hash-extension-attack/"/>
    <updated>2014-08-06T17:43:01-04:00</updated>
    <id>http://marqsm.github.io/blog/2014/08/06/hash-extension-attack</id>
    <content type="html"><![CDATA[<hr />

<h2>Hash extension attack</h2>

<p>We had <a href="https://filippo.io/">Filippo Valsorda</a> hold a small presentation at <a href="http://www.hackerschool.com">Hacker School</a> today. The topic has how to exploit a hash extension vulnerability.</p>

<p>Problem lies in a combination of how hash-functions work, and unsafe ways of transmitting an API-secret in a request. The example-case was VIMEO&rsquo;s old API that had this vulnerability some years ago (nowdays the vulnerability is fixed).</p>

<h3>About MD5-hashes</h3>

<p><a href="http://en.wikipedia.org/wiki/MD5">MD5 hashes</a>  can&rsquo;t be reversed, it&rsquo;s a one-way functions.</p>

<p>This means  checking equality a server checks hashes a string and compares it with the received hashed string. The actual passwords are never compared, just the hashes.For ex. a naive hashed password check would mean taking a password from the database and comparing it with the hashed password from client.</p>

<p>MD5 hashses are nearly unique - accidental collisions are extremely rare, but a <a href="http://en.wikipedia.org/wiki/Collision_attack">collision attack</a> is possible. It&rsquo;s an iterative hash function, which means hashes are created by combining 512-bit (=64 byte) chunks of the input the the hash seed (which is predefined in MD5 spec). The hash is created only based on the input, so the next seed is formed from the created hash etc. This means the hash has to be extensible.</p>

<h3>The vulnerability</h3>

<p>The extensibility is built so, that there is no secret component. This means if someone captures the hash, they can extend it. This is important.</p>

<p>In this case, the hashed signature string was created by concatenating secret and key-value pairs alphabetically, md5-hashing that string, and adding it as api_sig value to the request. So (in this request) naive pseudocode representation of the request could be:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>method: vimeo.test.login
</span><span class='line'>api_key: e1df59512d6e136e5ba0936e8ac273cb
</span><span class='line'>api_sig: hash_md5(api_secret + "api_key" + api_key + "method" + method)</span></code></pre></td></tr></table></div></figure>


<p>So the hash would be created from string</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sec12345api_keye1df59512d6e136e5ba0936e8ac273cbmethodvimeo.test.login</span></code></pre></td></tr></table></div></figure>


<p>This had two design flaws:
- The secret was prepended to the string that was hashed
- All the other components (except the secret) is passed in plaintext in the request</p>

<p>If the attacker captures a request (eg. by doing a <a href="http://en.wikipedia.org/wiki/Man-in-the-middle_attack">man-in-the-middle-attack</a>), changes the content, extends the signature hash to match the new request content, she can successfully pretend to be the original user and run any command she wishes (presuming it&rsquo;s allowed for the original user).</p>

<p>Example of the forged request:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>a: api_keye1df59512d6e136e5ba0936e8ac273cbmethodvimeo.test.login\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe8\x02\x00\x00\x00\x00\x00\x00
</span><span class='line'>video_id: 1337
</span><span class='line'>favorite: 1
</span><span class='line'>method: vimeo.videos.setFavorite
</span><span class='line'>api_key: e1df59512d6e136e5ba0936e8ac273cb
</span><span class='line'>api_sig: caf3d8384c2fbf2917c2b78dcf8ac588</span></code></pre></td></tr></table></div></figure>


<p><code>api_sig</code> is formed by hashing the whole new request key-value pairs in alphabetical order. An important part is the <code>a</code>-attribute, which contains the old request + padding required by MD5, which can be considered just an implementation detail. The main idea is that the new signature can be constructed from the old request and new added key-value pairs, which may be completely different from the original ones.</p>

<h3>Further reading</h3>

<p>A more complete article about hash-extension attacks
<a href="https://blog.skullsecurity.org/2012/everything-you-need-to-know-about-hash-length-extension-attacks">https://blog.skullsecurity.org/2012/everything-you-need-to-know-about-hash-length-extension-attacks</a></p>

<p>A very thorough article about why and how to use salts &amp; hashes when storing passwords: <a href="http://www.codeproject.com/Articles/704865/Salted-Password-Hashing-Doing-it-Right">http://www.codeproject.com/Articles/704865/Salted-Password-Hashing-Doing-it-Right</a></p>
]]></content>
  </entry>
  
</feed>
